import{j as e}from"./query-Bd_qUW7r.js";import{r as l}from"./router-Dd_x33oF.js";import{s as o}from"./index-uD7cecF-.js";import{k as D,a5 as Q,U as Z,l as ee,c as ae,B as re,ah as L,v as O,ai as K,i as U,ab as ne,m as te,D as le,X as ie,p as Y,n as oe,o as ce,F as de,aj as ue,R as me,a2 as xe,d as he}from"./ui-pfOMdjmO.js";import"./vendor-CXPvv_bO.js";import"./supabase-CvJM3N9j.js";const ge=({sessions:s,selectedSession:v,onSelectSession:u,loading:g})=>{const _=a=>{switch(a){case"active":return e.jsx(Q,{className:"text-green-500",size:16});case"pending":return e.jsx(K,{className:"text-yellow-500",size:16});case"resolved":return e.jsx(O,{className:"text-gray-500",size:16});default:return e.jsx(L,{className:"text-gray-500",size:16})}},T=a=>{switch(a){case"active":return"bg-green-500";case"pending":return"bg-yellow-500";case"resolved":return"bg-gray-500";default:return"bg-gray-500"}},E=a=>{const i=new Date(a),c=(new Date().getTime()-i.getTime())/(1e3*60*60);return c<1?`${Math.floor(c*60)}m ago`:c<24?`${Math.floor(c)}h ago`:i.toLocaleDateString()},N=a=>{const i=new Date(a),c=new Date().getTime()-i.getTime(),x=Math.floor(c/(1e3*60*60)),j=Math.floor(c%(1e3*60*60)/(1e3*60));return x>0?`${x}h ${j}m`:`${j}m`},y=a=>{switch(a){case"website":return"bg-blue-500/20 text-blue-400";case"seo":return"bg-green-500/20 text-green-400";case"support":return"bg-red-500/20 text-red-400";case"pricing":return"bg-yellow-500/20 text-yellow-400";default:return"bg-purple-500/20 text-purple-400"}};return g?e.jsx("div",{className:"flex items-center justify-center h-64",children:e.jsxs("div",{className:"flex items-center gap-2 text-gray-400",children:[e.jsx(D,{className:"animate-spin",size:20}),e.jsx("span",{children:"Loading conversations..."})]})}):s.length===0?e.jsxs("div",{className:"flex flex-col items-center justify-center h-64 text-gray-400",children:[e.jsx(Q,{size:48,className:"mb-4 opacity-50"}),e.jsx("p",{className:"text-lg font-medium mb-2",children:"No conversations found"}),e.jsx("p",{className:"text-sm text-center",children:"Chat conversations will appear here when customers start chatting"})]}):e.jsx("div",{className:"overflow-y-auto h-full bg-gray-800",children:s.map(a=>e.jsxs("div",{onClick:()=>u(a),className:`mx-1 my-1 p-2 rounded-lg cursor-pointer transition-colors border ${v?.id===a.id?"bg-purple-600 border-purple-500":"bg-gray-700 border-gray-600 hover:bg-gray-600"}`,children:[e.jsxs("div",{className:"flex items-center justify-between mb-2 relative z-10",children:[e.jsxs("div",{className:"flex items-center gap-2 min-w-0 flex-1",children:[e.jsx("div",{className:"bg-gradient-to-r from-purple-500/15 to-purple-600/15 p-1.5 rounded-full flex-shrink-0",children:e.jsx(Z,{className:"text-purple-300",size:12})}),e.jsx("span",{className:"text-white font-medium truncate text-sm",children:a.user_name}),a.unread_count&&a.unread_count>0&&e.jsx("span",{className:"bg-gradient-to-r from-red-500 to-red-600 text-white text-xs px-1.5 py-0.5 rounded-full min-w-[16px] h-4 flex items-center justify-center text-xs flex-shrink-0",children:a.unread_count})]}),e.jsxs("div",{className:"flex items-center gap-1 flex-shrink-0",children:[e.jsx("div",{className:"text-gray-400",children:_(a.status)}),e.jsx("div",{className:`w-2 h-2 rounded-full ${T(a.status)}`})]})]}),e.jsxs("div",{className:"space-y-1 mb-2 relative z-10",children:[e.jsxs("div",{className:"flex items-center gap-1 text-gray-400 text-xs",children:[e.jsx(ee,{size:8,className:"text-blue-400 flex-shrink-0"}),e.jsx("span",{className:"truncate",children:a.user_email})]}),a.user_phone&&e.jsxs("div",{className:"flex items-center gap-1 text-gray-400 text-xs",children:[e.jsx(ae,{size:8,className:"text-green-400 flex-shrink-0"}),e.jsx("span",{children:a.user_phone})]}),a.user_company&&e.jsxs("div",{className:"flex items-center gap-1 text-gray-400 text-xs",children:[e.jsx(re,{size:8,className:"text-purple-400 flex-shrink-0"}),e.jsx("span",{className:"truncate",children:a.user_company})]})]}),e.jsxs("div",{className:"space-y-1 mb-2 relative z-10",children:[a.inquiry_type&&e.jsx("span",{className:`text-xs px-2 py-0.5 rounded-full ${y(a.inquiry_type)} font-medium`,children:a.inquiry_type.charAt(0).toUpperCase()+a.inquiry_type.slice(1)}),a.last_message&&e.jsx("div",{className:"bg-gray-800/30 rounded-lg p-1.5",children:e.jsx("p",{className:"text-gray-400 text-xs leading-relaxed line-clamp-2",children:a.last_message.length>40?a.last_message.substring(0,40)+"...":a.last_message})})]}),e.jsxs("div",{className:"flex items-center justify-between text-xs text-gray-500",children:[e.jsxs("div",{className:"flex items-center gap-2",children:[e.jsxs("div",{className:"flex items-center gap-1",children:[e.jsx(L,{size:8,className:"text-blue-400"}),e.jsx("span",{children:E(a.last_message_time||a.created_at)})]}),e.jsx("span",{children:N(a.created_at)})]}),e.jsx("span",{className:`capitalize px-1.5 py-0.5 rounded text-xs font-medium ${a.status==="active"?"bg-green-600 text-white":a.status==="pending"?"bg-yellow-600 text-white":(a.status==="resolved","bg-gray-600 text-white")}`,children:a.status})]})]},a.id))})},pe=({session:s,onSessionUpdate:v})=>{const[u,g]=l.useState([]),[_,T]=l.useState(""),[E,N]=l.useState(!1),[y,a]=l.useState(!1),[i]=l.useState("Support Agent"),M=l.useRef(null),c=l.useRef(null),[x,j]=l.useState(null),[S,R]=l.useState(!1),C=l.useRef(null),[b,z]=l.useState(null),W=()=>{M.current?.scrollIntoView({behavior:"smooth"})};l.useEffect(()=>{W()},[u]),l.useEffect(()=>{if(!s){g([]);return}w(),A();const t=o.channel("chat-window-messages").on("postgres_changes",{event:"INSERT",schema:"public",table:"chat_messages",filter:`session_id=eq.${s.id}`},r=>{const m=r.new;g(d=>d.find($=>$.id===m.id)?d:[...d,m]),m.is_user&&H(m.id)}).on("postgres_changes",{event:"UPDATE",schema:"public",table:"chat_messages",filter:`session_id=eq.${s.id}`},r=>{g(m=>m.map(d=>d.id===r.new.id?{...d,...r.new}:d))}).subscribe();return()=>{o.removeChannel(t)}},[s]);const w=async()=>{if(s)try{N(!0);const{data:t,error:r}=await o.from("chat_messages").select("*").eq("session_id",s.id).order("created_at",{ascending:!0});if(r)throw r;g(t||[])}catch(t){console.error("Error fetching messages:",t)}finally{N(!1)}},A=async()=>{if(s)try{await o.from("chat_messages").update({is_read:!0}).eq("session_id",s.id).eq("is_user",!0).eq("is_read",!1)}catch(t){console.error("Error marking messages as read:",t)}},H=async t=>{try{await o.from("chat_messages").update({is_read:!0}).eq("id",t)}catch(r){console.error("Error marking message as read:",r)}},n=async t=>{if(t.preventDefault(),!_.trim()||!s||y)return;const r=_.trim(),m=`agent-temp-${Date.now()}-${Math.random()}`,d={id:m,session_id:s.id,user_email:"support@devtone.agency",message:r,is_user:!1,user_name:i,created_at:new Date().toISOString(),is_read:!0,metadata:{agent_name:i,sending:!0,temp:!0}};g(f=>[...f,d]),T(""),a(!0),G(!1),c.current&&(clearTimeout(c.current),c.current=null);try{const{data:f,error:$}=await o.from("chat_messages").insert({session_id:s.id,user_name:i,user_email:"support@devtone.agency",message:r,is_user:!1,is_read:!0,metadata:{agent_name:i,timestamp:new Date().toISOString()}}).select().single();if($)throw $;g(q=>q.map(B=>B.id===m?{...B,id:f.id,created_at:f.created_at,metadata:{...B.metadata,sent:!0,temp:!1}}:B)),s.status==="pending"&&(await o.from("chat_sessions").update({status:"active",updated_at:new Date().toISOString()}).eq("id",s.id),v())}catch(f){console.error("Error sending message:",f),g($=>$.map(q=>q.id===m?{...q,metadata:{...q.metadata,failed:!0}}:q))}finally{a(!1)}},h=async()=>{if(!(!s||b)){z("resolved");try{await o.from("chat_messages").insert({session_id:s.id,user_name:i,user_email:"support@devtone.agency",message:"âœ… This conversation has been marked as resolved by our support team. Thank you for contacting DevTone! If you need further assistance, please feel free to continue the conversation.",is_user:!1,is_read:!0,metadata:{agent_name:i,message_type:"system_resolved",timestamp:new Date().toISOString()}}),await o.from("chat_sessions").update({status:"resolved",updated_at:new Date().toISOString()}).eq("id",s.id),v(),alert("Conversation marked as resolved successfully!")}catch(t){console.error("Error marking as resolved:",t),alert("Error updating conversation status.")}finally{z(null)}}},k=async()=>{if(!(!s||b)){z("not_resolved");try{await o.from("chat_messages").insert({session_id:s.id,user_name:i,user_email:"support@devtone.agency",message:"ðŸ”„ This conversation has been reopened by our support team. We're here to help you further. Please let us know how we can assist you.",is_user:!1,is_read:!0,metadata:{agent_name:i,message_type:"system_reopened",timestamp:new Date().toISOString()}}),await o.from("chat_sessions").update({status:"active",updated_at:new Date().toISOString()}).eq("id",s.id),v(),alert("Conversation reopened successfully!")}catch(t){console.error("Error marking as not resolved:",t),alert("Error updating conversation status.")}finally{z(null)}}},I=async()=>{if(!(!s||b||!window.confirm(`Are you sure you want to close this conversation?

This will:
â€¢ Close the chat on both agent and client side
â€¢ Send a closure message to the client
â€¢ Hide the conversation from the dashboard
â€¢ Preserve all conversation data

The client will be notified that the conversation is closed.`))){z("close");try{await o.from("chat_messages").insert({session_id:s.id,user_name:i,user_email:"support@devtone.agency",message:"ðŸ”’ This conversation has been closed by our support team. Thank you for contacting DevTone! If you need further assistance, please start a new chat.",is_user:!1,is_read:!0,metadata:{agent_name:i,message_type:"system_closed",timestamp:new Date().toISOString()}}),await o.channel(`session_close:${s.id}`).send({type:"broadcast",event:"conversation_closed",payload:{session_id:s.id,message:`ðŸ”’ This conversation has been closed by our support team.

Thank you for contacting DevTone!

If you need further assistance, please start a new chat.`,closed_by:i,timestamp:new Date().toISOString()}}),await new Promise(m=>setTimeout(m,1500)),await o.from("chat_sessions").update({status:"closed",updated_at:new Date().toISOString()}).eq("id",s.id),v(),alert("Conversation closed successfully. The client has been notified and their chat will close automatically.")}catch(r){console.error("Error closing conversation:",r),alert("Error closing conversation. Please try again.")}finally{z(null)}}},F=()=>{if(!s)return"";const t=new Date(s.created_at),m=new Date().getTime()-t.getTime(),d=Math.floor(m/(1e3*60*60)),f=Math.floor(m%(1e3*60*60)/(1e3*60));return d>0?`${d}h ${f}m`:`${f}m`},p=t=>{const r=t.target.files?.[0];if(r){if(r.size>5*1024*1024){alert("File size must be less than 5MB");return}j(r)}},X=t=>new Promise((r,m)=>{const d=new FileReader;d.readAsDataURL(t),d.onload=()=>r(d.result),d.onerror=f=>m(f)}),P=async()=>{if(!(!x||!s||S)){R(!0);try{const t=await X(x),{error:r}=await o.from("chat_messages").insert({session_id:s.id,user_name:i,user_email:"support@devtone.agency",message:`ðŸ“Ž File shared: ${x.name}`,is_user:!1,is_read:!0,metadata:{agent_name:i,message_type:"file",file_name:x.name,file_data:t,file_size:x.size,file_type:x.type,timestamp:new Date().toISOString()}});if(r)throw r;j(null),C.current&&(C.current.value="")}catch(t){console.error("Error sending file:",t),alert("Failed to send file")}finally{R(!1)}}},V=t=>t.startsWith("image/")?e.jsx(ce,{size:16,className:"text-blue-400"}):t.includes("pdf")||t.includes("document")?e.jsx(de,{size:16,className:"text-red-400"}):e.jsx(Y,{size:16,className:"text-gray-400"}),J=t=>{if(t===0)return"0 Bytes";const r=1024,m=["Bytes","KB","MB","GB"],d=Math.floor(Math.log(t)/Math.log(r));return parseFloat((t/Math.pow(r,d)).toFixed(2))+" "+m[d]},G=async t=>{if(s)try{await o.channel(`typing:${s.id}`).send({type:"broadcast",event:"typing",payload:{session_id:s.id,is_user:!1,is_typing:t,agent_name:i}})}catch(r){console.error("Error sending typing indicator:",r)}},se=t=>{const r=t.target.value;T(r),r.length>0&&!c.current&&G(!0),c.current&&clearTimeout(c.current),c.current=setTimeout(()=>{G(!1),c.current=null},1e3)};return s?e.jsxs("div",{className:"flex flex-col h-full bg-gray-900 overflow-hidden",children:[e.jsxs("div",{className:"bg-gray-800 border-b border-gray-700 p-2 flex-shrink-0",children:[e.jsxs("div",{className:"flex items-center justify-between",children:[e.jsxs("div",{className:"flex items-center gap-2 min-w-0 flex-1",children:[e.jsx("div",{className:"w-8 h-8 bg-purple-600 rounded-full flex items-center justify-center flex-shrink-0",children:e.jsx(Z,{className:"text-white",size:12})}),e.jsxs("div",{className:"min-w-0 flex-1",children:[e.jsx("h3",{className:"text-white font-semibold text-sm truncate",children:s.user_name}),e.jsxs("div",{className:"flex items-center gap-2 text-xs text-gray-400",children:[e.jsxs("div",{className:"flex items-center gap-1",children:[e.jsx(ee,{size:8,className:"text-blue-400"}),e.jsx("span",{className:"truncate max-w-[120px]",children:s.user_email})]}),e.jsxs("div",{className:"flex items-center gap-1",children:[e.jsx(L,{size:8,className:"text-orange-400"}),e.jsx("span",{children:F()})]})]})]})]}),e.jsxs("div",{className:"flex items-center gap-1 flex-shrink-0",children:[e.jsx("span",{className:`px-2 py-1 text-xs rounded font-medium ${s.status==="active"?"bg-green-600 text-white":s.status==="pending"?"bg-yellow-600 text-white":s.status==="resolved"?"bg-blue-600 text-white":"bg-gray-600 text-white"}`,children:s.status.charAt(0).toUpperCase()+s.status.slice(1)}),e.jsxs("button",{onClick:h,className:"px-2 py-1 bg-green-600 hover:bg-green-700 text-white text-xs rounded transition-colors flex items-center gap-1 disabled:opacity-50 disabled:cursor-not-allowed",title:"Mark as Resolved",disabled:s.status==="resolved"||b!==null,children:[b==="resolved"?e.jsx(D,{size:10,className:"animate-spin"}):e.jsx(O,{size:10}),e.jsx("span",{children:"Resolved"})]}),e.jsxs("button",{onClick:k,className:"px-2 py-1 bg-orange-600 hover:bg-orange-700 text-white text-xs rounded transition-colors flex items-center gap-1 disabled:opacity-50 disabled:cursor-not-allowed",title:"Mark as Not Resolved (Reopen)",disabled:s.status==="active"||b!==null,children:[b==="not_resolved"?e.jsx(D,{size:10,className:"animate-spin"}):e.jsx(K,{size:10}),e.jsx("span",{children:"Reopen"})]}),e.jsxs("button",{onClick:I,className:"px-2 py-1 bg-red-600 hover:bg-red-700 text-white text-xs rounded transition-colors flex items-center gap-1 disabled:opacity-50 disabled:cursor-not-allowed",title:"Close Conversation",disabled:b!==null,children:[b==="close"?e.jsx(D,{size:10,className:"animate-spin"}):e.jsx(ne,{size:10}),e.jsx("span",{children:"Close"})]})]})]}),s.inquiry_type&&e.jsx("div",{className:"mt-1",children:e.jsx("span",{className:"inline-block px-2 py-0.5 bg-purple-600 text-white text-xs rounded",children:s.inquiry_type.charAt(0).toUpperCase()+s.inquiry_type.slice(1)})})]}),e.jsx("div",{className:"flex-1 overflow-y-auto p-4 space-y-4 min-h-0",children:E?e.jsx("div",{className:"flex items-center justify-center h-full",children:e.jsxs("div",{className:"flex items-center gap-2 text-gray-400",children:[e.jsx(D,{className:"animate-spin",size:20}),e.jsx("span",{children:"Loading messages..."})]})}):e.jsxs(e.Fragment,{children:[u.map(t=>e.jsx(te.div,{initial:{opacity:0,y:10},animate:{opacity:1,y:0},className:`flex ${t.is_user?"justify-end":"justify-start"}`,children:e.jsxs("div",{className:`max-w-[70%] rounded-2xl px-4 py-2 ${t.is_user?"bg-purple-600 text-white":"bg-gray-700 text-white"}`,children:[!t.is_user&&e.jsx("div",{className:"text-xs text-gray-300 mb-1",children:t.user_name}),e.jsx("p",{className:"whitespace-pre-wrap",children:t.message}),t.metadata?.message_type==="file"&&e.jsxs("div",{className:"mt-2 p-3 bg-black/20 rounded-lg border border-white/10",children:[e.jsxs("div",{className:"flex items-center gap-2 mb-2",children:[V(t.metadata.file_type),e.jsx("span",{className:"text-sm font-medium",children:t.metadata.file_name})]}),e.jsx("div",{className:"text-xs text-gray-300 mb-2",children:J(t.metadata.file_size)}),t.metadata.file_type.startsWith("image/")?e.jsx("div",{className:"mb-2",children:e.jsx("img",{src:t.metadata.file_data,alt:t.metadata.file_name,className:"max-w-full max-h-48 rounded border"})}):null,e.jsxs("a",{href:t.metadata.file_data,download:t.metadata.file_name,className:"inline-flex items-center gap-1 text-xs bg-blue-600 hover:bg-blue-700 px-2 py-1 rounded transition-colors",children:[e.jsx(le,{size:12}),"Download"]})]}),e.jsxs("div",{className:`text-xs mt-1 ${t.is_user?"text-purple-200":"text-gray-400"}`,children:[new Date(t.created_at).toLocaleTimeString([],{hour:"2-digit",minute:"2-digit"}),t.is_user&&e.jsx("span",{className:"ml-2",children:t.is_read?e.jsx(O,{size:12,className:"inline"}):e.jsx(L,{size:12,className:"inline"})})]})]})},t.id)),e.jsx("div",{ref:M})]})}),e.jsxs("div",{className:"bg-gray-800 border-t border-gray-700 p-4 flex-shrink-0",children:[x&&e.jsx("div",{className:"mb-3 p-3 bg-gray-700 rounded-lg border border-gray-600",children:e.jsxs("div",{className:"flex items-center justify-between",children:[e.jsxs("div",{className:"flex items-center gap-2",children:[V(x.type),e.jsxs("div",{children:[e.jsx("p",{className:"text-white text-sm font-medium",children:x.name}),e.jsx("p",{className:"text-gray-400 text-xs",children:J(x.size)})]})]}),e.jsxs("div",{className:"flex items-center gap-2",children:[e.jsx("button",{onClick:P,disabled:S,className:"bg-green-600 hover:bg-green-700 text-white px-3 py-1 rounded text-sm transition-colors disabled:opacity-50",children:S?e.jsx(D,{className:"animate-spin",size:14}):"Send File"}),e.jsx("button",{onClick:()=>{j(null),C.current&&(C.current.value="")},className:"text-gray-400 hover:text-white",children:e.jsx(ie,{size:16})})]})]})}),e.jsxs("form",{onSubmit:n,className:"flex items-center gap-2",children:[e.jsx("input",{ref:C,type:"file",onChange:p,accept:"image/*,.pdf,.doc,.docx,.txt,.zip,.rar",className:"hidden"}),e.jsx("button",{type:"button",onClick:()=>C.current?.click(),className:"bg-gray-700 hover:bg-gray-600 text-gray-300 rounded-lg p-2 transition-colors",title:"Attach File",children:e.jsx(Y,{size:18})}),e.jsx("input",{type:"text",value:_,onChange:se,placeholder:"Type your response...",className:"flex-1 bg-gray-700 border border-gray-600 rounded-lg px-4 py-2 text-white focus:outline-none focus:ring-2 focus:ring-purple-500",disabled:y||S}),e.jsx("button",{type:"submit",disabled:!_.trim()||y||S,className:"bg-purple-600 text-white rounded-lg px-4 py-2 hover:bg-purple-700 transition-colors disabled:opacity-50 disabled:cursor-not-allowed",children:y?e.jsx(D,{className:"animate-spin",size:18}):e.jsx(oe,{size:18})})]})]})]}):e.jsx("div",{className:"flex items-center justify-center h-full bg-gray-900",children:e.jsxs("div",{className:"text-center text-gray-400",children:[e.jsx(U,{size:64,className:"mx-auto mb-4 opacity-50"}),e.jsx("h3",{className:"text-xl font-medium mb-2",children:"No conversation selected"}),e.jsx("p",{children:"Select a conversation from the list to start chatting"})]})})},fe=({stats:s})=>{const v=[{title:"Total Conversations",value:s.total_sessions,icon:U,color:"text-blue-500",bgColor:"bg-blue-500/10",borderColor:"border-blue-500/20"},{title:"Active Chats",value:s.active_sessions,icon:ue,color:"text-green-500",bgColor:"bg-green-500/10",borderColor:"border-green-500/20"},{title:"Pending Response",value:s.pending_sessions,icon:K,color:"text-yellow-500",bgColor:"bg-yellow-500/10",borderColor:"border-yellow-500/20"},{title:"Resolved Today",value:s.resolved_sessions,icon:O,color:"text-purple-500",bgColor:"bg-purple-500/10",borderColor:"border-purple-500/20"},{title:"Avg Response Time",value:`${s.avg_response_time}m`,icon:L,color:"text-indigo-500",bgColor:"bg-indigo-500/10",borderColor:"border-indigo-500/20"}];return e.jsx("div",{className:"bg-gray-800 border-b border-gray-700 px-4 py-2 h-16 flex items-center",children:e.jsx("div",{className:"grid grid-cols-5 gap-4 w-full",children:v.map((u,g)=>e.jsxs("div",{className:`${u.bgColor} ${u.borderColor} border rounded-lg p-2 flex items-center gap-2`,children:[e.jsx("div",{className:`${u.color} ${u.bgColor} p-1.5 rounded-full flex-shrink-0`,children:e.jsx(u.icon,{size:12})}),e.jsxs("div",{className:"min-w-0 flex-1",children:[e.jsx("p",{className:"text-gray-300 text-xs font-medium truncate",children:u.title}),e.jsx("p",{className:`text-sm font-bold ${u.color}`,children:typeof u.value=="number"?u.value.toLocaleString():u.value})]})]},u.title))})})},Ne=()=>{const[s,v]=l.useState([]),[u,g]=l.useState(null),[_,T]=l.useState({total_sessions:0,active_sessions:0,pending_sessions:0,resolved_sessions:0,avg_response_time:0}),[E,N]=l.useState(!0),[y,a]=l.useState(""),[i,M]=l.useState("all"),[c,x]=l.useState(!1),[j,S]=l.useState(""),[R,C]=l.useState("disconnected"),[b,z]=l.useState(!1);l.useRef(null);const W=n=>{n.preventDefault(),j==="devtone2024"?(x(!0),localStorage.setItem("chat_dashboard_auth","true")):alert("Invalid password")};l.useEffect(()=>{localStorage.getItem("chat_dashboard_auth")==="true"&&x(!0)},[]);const w=async(n=!1)=>{try{N(!0);let h=o.from("chat_sessions").select(`
          *,
          chat_messages(count)
        `);!n&&i!=="closed"?h=h.neq("status","closed"):i==="closed"&&(h=h.eq("status","closed"));const{data:k,error:I}=await h.order("updated_at",{ascending:!1});if(I)throw I;const F=await Promise.all((k||[]).map(async p=>{const{count:X}=await o.from("chat_messages").select("*",{count:"exact",head:!0}).eq("session_id",p.id).eq("is_user",!0).eq("is_read",!1),{data:P}=await o.from("chat_messages").select("message, created_at, is_user").eq("session_id",p.id).order("created_at",{ascending:!1}).limit(1).single();return{...p,unread_count:X||0,last_message:P?.message||"",last_message_time:P?.created_at||p.created_at}}));v(F)}catch(h){console.error("Error fetching sessions:",h)}finally{N(!1)}},A=async()=>{try{const{data:n}=await o.from("chat_sessions").select("status, created_at");if(n){const h=n.length,k=n.filter(p=>p.status==="active").length,I=n.filter(p=>p.status==="pending").length,F=n.filter(p=>p.status==="resolved").length;T({total_sessions:h,active_sessions:k,pending_sessions:I,resolved_sessions:F,avg_response_time:2.5})}}catch(n){console.error("Error fetching stats:",n)}};l.useEffect(()=>{if(!c)return;w(),A();const n=o.channel("dashboard-sessions").on("postgres_changes",{event:"*",schema:"public",table:"chat_sessions"},()=>{w(),A()}).subscribe(),h=o.channel("dashboard-messages").on("postgres_changes",{event:"INSERT",schema:"public",table:"chat_messages"},()=>{w()}).subscribe();return()=>{o.removeChannel(n),o.removeChannel(h)}},[c]),l.useEffect(()=>{c&&w()},[i]);const H=s.filter(n=>{const h=n.user_name.toLowerCase().includes(y.toLowerCase())||n.user_email.toLowerCase().includes(y.toLowerCase())||n.user_company&&n.user_company.toLowerCase().includes(y.toLowerCase()),k=i==="all"||n.status===i;return h&&k});return c?e.jsxs("div",{className:"fixed inset-0 bg-gray-900 z-50 flex flex-col h-screen overflow-hidden",children:[e.jsx("div",{className:"bg-gray-800 border-b border-gray-700 px-4 py-2 h-14 flex-shrink-0",children:e.jsxs("div",{className:"flex items-center justify-between h-full",children:[e.jsxs("div",{className:"flex items-center gap-3",children:[e.jsx("div",{className:"bg-purple-600 p-2 rounded-full",children:e.jsx(U,{className:"text-white",size:16})}),e.jsxs("div",{children:[e.jsx("h1",{className:"text-lg font-bold text-white",children:"DevTone Chat Dashboard"}),e.jsx("p",{className:"text-gray-400 text-xs",children:"Manage customer support conversations"})]})]}),e.jsxs("div",{className:"flex items-center gap-2",children:[e.jsxs("div",{className:"flex items-center gap-1 bg-gray-700 px-2 py-1 rounded-full",children:[e.jsx("div",{className:`w-2 h-2 rounded-full ${R==="connected"?"bg-green-400":R==="error"?"bg-orange-400":"bg-red-400"}`}),e.jsx("span",{className:"text-xs text-gray-400",children:b?"Polling":"Live"})]}),e.jsxs("button",{onClick:()=>{w(),A()},className:"flex items-center gap-1 px-3 py-1 bg-purple-600 text-white rounded-full hover:bg-purple-700 transition-colors text-xs",children:[e.jsx(me,{size:12}),e.jsx("span",{children:"Refresh"})]}),e.jsxs("button",{onClick:()=>{localStorage.removeItem("chat_dashboard_auth"),x(!1),window.location.href="/"},className:"flex items-center gap-1 px-3 py-1 bg-red-600 text-white rounded-full hover:bg-red-700 transition-colors text-xs",children:[e.jsx(xe,{size:12}),e.jsx("span",{children:"Logout"})]})]})]})}),e.jsx("div",{className:"h-16 flex-shrink-0",children:e.jsx(fe,{stats:_})}),e.jsxs("div",{className:"flex-1 flex h-[calc(100vh-112px)] overflow-hidden",children:[e.jsxs("div",{className:"w-80 bg-gray-800 border-r border-gray-700 flex flex-col",children:[e.jsx("div",{className:"p-2 border-b border-gray-700 flex-shrink-0 bg-gray-800",children:e.jsxs("div",{className:"space-y-2",children:[e.jsxs("div",{className:"relative",children:[e.jsx(he,{className:"absolute left-3 top-1/2 transform -translate-y-1/2 text-gray-400",size:12}),e.jsx("input",{type:"text",value:y,onChange:n=>a(n.target.value),placeholder:"Search conversations...",className:"w-full pl-8 pr-3 py-1.5 bg-gray-700 border border-gray-600 rounded-lg text-white text-xs focus:outline-none focus:ring-1 focus:ring-purple-500 placeholder-gray-400"})]}),e.jsxs("select",{value:i,onChange:n=>M(n.target.value),className:"w-full px-3 py-1.5 bg-gray-700 border border-gray-600 rounded-lg text-white text-xs focus:outline-none focus:ring-1 focus:ring-purple-500",children:[e.jsx("option",{value:"all",children:"All Status"}),e.jsx("option",{value:"active",children:"Active"}),e.jsx("option",{value:"pending",children:"Pending"}),e.jsx("option",{value:"resolved",children:"Resolved"}),e.jsx("option",{value:"closed",children:"Closed"})]})]})}),e.jsx("div",{className:"flex-1 overflow-y-auto",children:e.jsx(ge,{sessions:H,selectedSession:u,onSelectSession:g,loading:E})})]}),e.jsx("div",{className:"flex-1 flex flex-col overflow-hidden",children:e.jsx(pe,{session:u,onSessionUpdate:w})})]})]}):e.jsx("div",{className:"fixed inset-0 bg-gray-900 flex items-center justify-center z-50",children:e.jsxs(te.div,{initial:{opacity:0,y:20},animate:{opacity:1,y:0},className:"bg-gray-800 p-8 rounded-3xl shadow-2xl w-full max-w-md border border-purple-500/20",children:[e.jsxs("div",{className:"text-center mb-6",children:[e.jsx(U,{className:"mx-auto text-purple-500 mb-4",size:48}),e.jsx("h1",{className:"text-2xl font-bold text-white mb-2",children:"Chat Dashboard"}),e.jsx("p",{className:"text-gray-400",children:"Enter password to access support dashboard"})]}),e.jsxs("form",{onSubmit:W,children:[e.jsx("input",{type:"password",value:j,onChange:n=>S(n.target.value),placeholder:"Enter password",className:"w-full px-4 py-3 bg-gray-700 border border-gray-600 rounded-lg text-white focus:outline-none focus:ring-2 focus:ring-purple-500 mb-4",required:!0}),e.jsx("button",{type:"submit",className:"w-full py-3 bg-gradient-to-r from-purple-500 to-purple-700 text-white rounded-lg font-medium hover:from-purple-600 hover:to-purple-800 transition-colors",children:"Access Dashboard"})]})]})})};export{Ne as default};
